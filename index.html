<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Si√™u T·ª´ V·ª±ng Ti·∫øng Trung (HSK 1‚Äì5) ‚Äì Gamification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===========================
       BASIC RESET & LAYOUT
    =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: #f2f3f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    button {
      cursor: pointer;
    }
    img {
      max-width: 100%;
      display: block;
    }

    /* ===========================
       HEADER
    =========================== */
    header {
      background-color: #5e35b1;
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: relative;
    }
    header h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      font-size: 0.9rem;
    }
    .stats div {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .stats div span.icon {
      font-size: 1.2rem;
    }

    /* ===========================
       MAIN QUIZ AREA
    =========================== */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    .controls {
      margin-bottom: 1rem;
      width: 100%;
      max-width: 400px;
      display: flex;
      gap: 0.5rem;
    }
    .controls select, .controls button {
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      flex: 1;
    }
    .controls button {
      background-color: #5e35b1;
      color: #fff;
      border: none;
    }
    .quiz-container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .question-text {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .option {
      padding: 0.7rem 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      background-color: #fafafa;
      transition: background-color 0.2s, border-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .option.correct {
      background-color: #c8e6c9;
      border-color: #388e3c;
    }
    .option.wrong {
      background-color: #ffcdd2;
      border-color: #d32f2f;
    }
    .option.disabled {
      pointer-events: none;
      opacity: 0.7;
    }
    .option span.pinyin {
      display: block;
      font-size: 0.85rem;
      color: #666;
    }
    .next-btn {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      background-color: #5e35b1;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
      display: none;
    }
    .progress {
      margin-top: 0.8rem;
      text-align: center;
      color: #555;
    }

    /* ===========================
       BADGES & LEADERBOARD
    =========================== */
    .badges-container, .leaderboard-container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
    }
    .badges-container h2,
    .leaderboard-container h2 {
      font-size: 1.1rem;
      margin-bottom: 0.8rem;
      color: #5e35b1;
    }
    .badges-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .badge {
      background-color: #eee;
      color: #555;
      border-radius: 4px;
      padding: 0.4rem 0.7rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .badge.earned {
      background-color: #ffd54f;
      color: #444;
    }
    .badge span.icon {
      font-size: 1rem;
    }
    .leaderboard-list {
      list-style: none;
    }
    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid #ddd;
      font-size: 0.9rem;
    }
    .leaderboard-item:last-child {
      border-bottom: none;
    }
    .leaderboard-item span.rank {
      width: 20px;
      text-align: center;
      color: #777;
    }
    .leaderboard-item span.name {
      flex: 1;
      margin-left: 0.5rem;
      color: #333;
    }
    .leaderboard-item span.score {
      width: 50px;
      text-align: right;
      color: #5e35b1;
    }

    /* ===========================
       FOOTER
    =========================== */
    footer {
      text-align: center;
      padding: 0.8rem 0;
      font-size: 0.9rem;
      color: #666;
    }

    /* ===========================
       RESPONSIVE
    =========================== */
    @media (max-width: 480px) {
      header h1 { font-size: 1.3rem; }
      .stats { flex-direction: column; gap: 0.3rem; }
      .quiz-container, .badges-container, .leaderboard-container {
        padding: 1rem;
      }
      .controls { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- ============= HEADER (Score, Combo, Streak) ============= -->
  <header>
    <h1>Si√™u T·ª´ V·ª±ng Ti·∫øng Trung (HSK 1‚Äì5)</h1>
    <div class="stats">
      <div class="stat-score">
        <span class="icon">‚≠ê</span>
        <span id="scoreValue">0</span>
      </div>
      <div class="stat-combo">
        <span class="icon">üî•</span>
        <span id="comboValue">0</span>
      </div>
      <div class="stat-streak">
        <span class="icon">üìÜ</span>
        <span id="streakValue">0 ng√†y</span>
      </div>
    </div>
  </header>

  <!-- ============= MAIN CONTENT ============= -->
  <main>

    <!-- 1) Ch·ªçn c·∫•p ƒë·ªô & B·∫Øt ƒë·∫ßu Quiz -->
    <div class="controls">
      <select id="levelSelect">
        <option value="ALL">T·∫•t c·∫£ (HSK 1‚Äì5)</option>
        <option value="HSK1">HSK 1</option>
        <option value="HSK2">HSK 2</option>
        <option value="HSK3">HSK 3</option>
        <option value="HSK4">HSK 4</option>
        <option value="HSK5">HSK 5</option>
      </select>
      <button id="startQuizBtn">B·∫Øt ƒë·∫ßu Quiz</button>
    </div>

    <!-- 2) H·ªôp quiz (c√¢u h·ªèi + options) -->
    <div class="quiz-container" id="quizContainer" style="display: none;">
      <div class="question-text" id="questionText">
        <!-- ‚ÄúCh·ªçn ch·ªØ H√°n c√≥ nghƒ©a: ‚Ä¶‚Äù -->
      </div>
      <div class="options" id="optionsContainer">
        <!-- C√°c options s·∫Ω ƒë∆∞·ª£c ƒë·ªï v√†o ƒë√¢y -->
      </div>
      <button class="next-btn" id="nextBtn">C√¢u Ti·∫øp Theo</button>
      <div class="progress" id="progressText">0 / 0</div>
    </div>

    <!-- 3) Badges (Huy hi·ªáu) -->
    <div class="badges-container">
      <h2>Huy hi·ªáu ƒë√£ ƒë·∫°t ƒë∆∞·ª£c</h2>
      <div class="badges-list" id="badgesList">
        <!-- Badge items s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
      </div>
    </div>

    <!-- 4) Leaderboard (Top ƒëi·ªÉm) -->
    <div class="leaderboard-container">
      <h2>BXH (Leaderboard)</h2>
      <ul class="leaderboard-list" id="leaderboardList">
        <!-- Top 10 s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
      </ul>
    </div>

  </main>

  <!-- ============= FOOTER ============= -->
  <footer>
    ¬© 2025 ‚Äì Si√™u T·ª´ V·ª±ng ‚Äì H·ªçc ti·∫øng Trung m·ªói ng√†y
  </footer>

  <!-- ============= JAVASCRIPT ============= -->
  <script>
  (function(){
    "use strict";

    //
    // ‚îÄ‚îÄ‚îÄ I. D·ªÆ LI·ªÜU V√Ä BI·∫æN TO√ÄN C·ª§C ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    let allWords = [];       // M·∫£ng ch·ª©a to√†n b·ªô t·ª´ (t·∫£i t·ª´ words.json)
    let quizWords = [];      // M·∫£ng ch·ªâ ch·ª©a t·ª´ theo level v·ª´a ch·ªçn
    let currentIdx = 0;      // Index trong quizWords
    let score = 0;           // T·ªïng ƒëi·ªÉm
    let combo = 0;           // Combo (s·ªë c√¢u li√™n ti·∫øp tr·∫£ l·ªùi ƒë√∫ng)
    let maxCombo = 0;        // Combo cao nh·∫•t trong l·∫ßn ch∆°i
    let streakDays = 0;      // S·ªë ng√†y li√™n ti·∫øp ƒë√£ h·ªçc
    let todayDate = "";      // L∆∞u ng√†y h√¥m nay d∆∞·ªõi d·∫°ng "YYYY-MM-DD"
    let userName = "";       // T√™n ng∆∞·ªùi ch∆°i (nh·∫≠p tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu)

    // C√°c badges (huy hi·ªáu) v√† ƒëi·ªÅu ki·ªán ƒë·∫°t:
    //   - badge id: string ƒë·ªãnh danh
    //   - label: t√™n hi·ªÉn th·ªã
    //   - icon: emoji (ho·∫∑c icon ng·∫Øn)
    //   - condition: h√†m ki·ªÉm tra n·∫øu badge ƒë√£ ƒë·∫°t hay ch∆∞a
    // Badge s·∫Ω ƒë∆∞·ª£c l∆∞u trong localStorage d∆∞·ªõi key "earnedBadges" (m·∫£ng ch·ª©a badge id)
    const BADGES = [
      {
        id: "first_correct",
        label: "L·∫ßn ƒë·∫ßu Tr·∫£ L·ªùi ƒê√∫ng",
        icon: "üéâ",
        condition: (stats) => stats.correctAnswers >= 1
      },
      {
        id: "combo5",
        label: "5 C√¢u Li√™n Ti·∫øp ƒê√∫ng",
        icon: "üî•",
        condition: (stats) => stats.maxCombo >= 5
      },
      {
        id: "combo10",
        label: "10 C√¢u Li√™n Ti·∫øp ƒê√∫ng",
        icon: "üí•",
        condition: (stats) => stats.maxCombo >= 10
      },
      {
        id: "streak7",
        label: "Chu·ªói 7 Ng√†y Li√™n Ti·∫øp",
        icon: "üèÖ",
        condition: (stats) => stats.streak >= 7
      },
      {
        id: "streak30",
        label: "Chu·ªói 30 Ng√†y Li√™n Ti·∫øp",
        icon: "ü•á",
        condition: (stats) => stats.streak >= 30
      }
    ];

    // Leaderboard l∆∞u trong localStorage d∆∞·ªõi key "leaderboardList"
    // ƒê√¢y l√† m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng: { name: "T√™n", score: 123, date: "YYYY-MM-DD" }
    const MAX_LEADERBOARD_ENTRIES = 10;

    //
    // ‚îÄ‚îÄ‚îÄ II. H√ÄM TI·ªÜN √çCH V·ªÄ NG√ÄY (DATE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    /**
     * Tr·∫£ v·ªÅ chu·ªói ‚ÄúYYYY-MM-DD‚Äù c·ªßa ng√†y hi·ªán t·∫°i
     */
    function getCurrentDateString() {
      const d = new Date();
      const y = d.getFullYear();
      let m = d.getMonth() + 1;
      let dd = d.getDate();
      if (m < 10) m = "0" + m;
      if (dd < 10) dd = "0" + dd;
      return `${y}-${m}-${dd}`;
    }

    /**
     * Ki·ªÉm tra xem dateString1 c√≥ ph·∫£i l√† ƒë√∫ng h√¥m tr∆∞·ªõc c·ªßa dateString2 kh√¥ng?
     * dateString1/dateString2 d·∫°ng "YYYY-MM-DD"
     */
    function isYesterday(dateString1, dateString2) {
      const d1 = new Date(dateString1);
      const d2 = new Date(dateString2);
      const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
      return diff === 1;
    }

    //
    // ‚îÄ‚îÄ‚îÄ III. QU·∫¢N L√ù STREAK (NG√ÄY LI√äN TI·∫æP) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    /**
     * Kh·ªüi t·∫°o ho·∫∑c c·∫≠p nh·∫≠t streak (d·ª±a v√†o ng√†y cu·ªëi c√πng h·ªçc)
     * L∆∞u trong localStorage:
     *   - key "lastPlayedDate": "YYYY-MM-DD" c·ªßa l·∫ßn ch∆°i cu·ªëi
     *   - key "streakDays": s·ªë ng√†y li√™n ti·∫øp tr∆∞·ªõc ƒë√≥
     */
    function initOrUpdateStreak() {
      todayDate = getCurrentDateString();
      const lastDate = localStorage.getItem("lastPlayedDate");
      let savedStreak = parseInt(localStorage.getItem("streakDays")) || 0;

      if (lastDate === todayDate) {
        // ƒê√£ ch∆°i h√¥m nay, kh√¥ng ƒë·ªïi streak
        streakDays = savedStreak;
      } else if (lastDate && isYesterday(lastDate, todayDate)) {
        // N·∫øu lastDate l√† ng√†y h√¥m qua, tƒÉng streak l√™n 1
        streakDays = savedStreak + 1;
        localStorage.setItem("streakDays", streakDays);
        localStorage.setItem("lastPlayedDate", todayDate);
      } else {
        // Kh·ªüi l·∫°i streak (0 ‚Üí 1) v√¨ ƒë√£ gi√°n ƒëo·∫°n ho·∫∑c l·∫ßn ƒë·∫ßu
        streakDays = 1;
        localStorage.setItem("streakDays", "1");
        localStorage.setItem("lastPlayedDate", todayDate);
      }
      // C·∫≠p nh·∫≠t ph·∫ßn hi·ªÉn th·ªã l√™n UI
      document.getElementById("streakValue").innerText = streakDays + " ng√†y";
    }

    //
    // ‚îÄ‚îÄ‚îÄ IV. QU·∫¢N L√ù BADGES (HUY HI·ªÜU) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    /**
     * L·∫•y danh s√°ch c√°c badge ƒë√£ ƒë·∫°t (m·∫£ng ch·ª©a id badge) t·ª´ localStorage
     */
    function getEarnedBadges() {
      const raw = localStorage.getItem("earnedBadges");
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    /**
     * L∆∞u danh s√°ch earnedBadges (m·∫£ng id) v·ªÅ localStorage
     */
    function saveEarnedBadges(arr) {
      localStorage.setItem("earnedBadges", JSON.stringify(arr));
    }

    /**
     * Ki·ªÉm tra & c·∫≠p nh·∫≠t badge m·ªõi n·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán
     * stats: { correctAnswers, maxCombo, streak }
     */
    function updateBadges(stats) {
      const earned = getEarnedBadges();
      let gained = false;

      BADGES.forEach(b => {
        if (!earned.includes(b.id) && b.condition(stats)) {
          earned.push(b.id);
          gained = true;
        }
      });

      if (gained) {
        saveEarnedBadges(earned);
      }
      renderBadges();
    }

    /**
     * Hi·ªÉn th·ªã badges trong ph·∫ßn UI
     */
    function renderBadges() {
      const earned = getEarnedBadges();
      const container = document.getElementById("badgesList");
      container.innerHTML = "";
      BADGES.forEach(b => {
        const div = document.createElement("div");
        div.className = "badge" + (earned.includes(b.id) ? " earned" : "");
        div.innerHTML = `<span class="icon">${b.icon}</span> ${b.label}`;
        container.appendChild(div);
      });
    }

    //
    // ‚îÄ‚îÄ‚îÄ V. QU·∫¢N L√ù LEADERBOARD (TOP ƒêI·ªÇM) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    /**
     * L·∫•y danh s√°ch leaderboard (m·∫£ng object {name, score, date}) t·ª´ localStorage
     */
    function getLeaderboard() {
      const raw = localStorage.getItem("leaderboardList");
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    /**
     * L∆∞u m·∫£ng leaderboard v·ªÅ localStorage
     */
    function saveLeaderboard(arr) {
      localStorage.setItem("leaderboardList", JSON.stringify(arr));
    }

    /**
     * Th√™m m·ªôt entry m·ªõi v√†o leaderboard (name, score, date), gi·ªØ top 10
     */
    function addToLeaderboard(name, scoreVal) {
      const all = getLeaderboard();
      all.push({
        name: name,
        score: scoreVal,
        date: getCurrentDateString()
      });
      // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo score
      all.sort((a,b) => b.score - a.score);
      // Gi·ªØ t·ªëi ƒëa MAX_LEADERBOARD_ENTRIES
      const top = all.slice(0, MAX_LEADERBOARD_ENTRIES);
      saveLeaderboard(top);
      renderLeaderboard();
    }

    /**
     * Hi·ªÉn th·ªã leaderboard l√™n UI
     */
    function renderLeaderboard() {
      const all = getLeaderboard();
      const ul = document.getElementById("leaderboardList");
      ul.innerHTML = "";
      all.forEach((item, idx) => {
        const li = document.createElement("li");
        li.className = "leaderboard-item";
        li.innerHTML = `
          <span class="rank">${idx + 1}</span>
          <span class="name">${item.name}</span>
          <span class="score">${item.score}</span>
        `;
        ul.appendChild(li);
      });
      if (all.length === 0) {
        const li = document.createElement("li");
        li.style.textAlign = "center";
        li.style.color = "#777";
        li.innerText = "Ch∆∞a c√≥ b·∫£ng x·∫øp h·∫°ng";
        ul.appendChild(li);
      }
    }

    //
    // ‚îÄ‚îÄ‚îÄ VI. QUIZ LOGIC C∆† B·∫¢N (TEXT) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    // Tham chi·∫øu ƒë·∫øn DOM elements
    const levelSelect    = document.getElementById("levelSelect");
    const startQuizBtn   = document.getElementById("startQuizBtn");
    const quizContainer  = document.getElementById("quizContainer");
    const questionText   = document.getElementById("questionText");
    const optionsContainer = document.getElementById("optionsContainer");
    const nextBtn        = document.getElementById("nextBtn");
    const progressText   = document.getElementById("progressText");
    const scoreValue     = document.getElementById("scoreValue");
    const comboValue     = document.getElementById("comboValue");
    const streakValue    = document.getElementById("streakValue");

    let correctAnswersCount = 0;  // T·ªïng s·ªë c√¢u tr·∫£ l·ªùi ƒë√∫ng trong l·∫ßn ch∆°i
    let levelFilter = "ALL";

    /**
     * T·∫£i to√†n b·ªô words.json (m·∫£ng c√°c object) v√†o bi·∫øn allWords
     * words.json ph·∫£i n·∫±m c·∫°nh index.html ho·∫∑c ƒë√∫ng ƒë∆∞·ªùng d·∫´n /words.json
     */
    async function loadAllWords() {
      try {
        const resp = await fetch("words.json");
        const data = await resp.json();
        allWords = data;
      } catch (err) {
        console.error("Kh√¥ng th·ªÉ load words.json:", err);
      }
    }

    /**
     * B·∫Øt ƒë·∫ßu quiz: l·ªçc theo level, random th·ª© t·ª±, reset bi·∫øn
     */
    function startQuiz() {
      levelFilter = levelSelect.value;
      // L·ªçc allWords theo levelFilter
      if (levelFilter === "ALL") {
        quizWords = [...allWords];
      } else {
        quizWords = allWords.filter(w => w.level === levelFilter);
      }
      // N·∫øu kh√¥ng c√≥ t·ª´ n√†o, c·∫£nh b√°o
      if (!quizWords.length) {
        alert("Kh√¥ng c√≥ t·ª´ n√†o cho c·∫•p ƒë·ªô n√†y.");
        return;
      }
      // Random shuffle quizWords
      quizWords.sort(() => Math.random() - 0.5);

      // Reset bi·∫øn
      currentIdx = 0;
      score = 0;
      combo = 0;
      maxCombo = 0;
      correctAnswersCount = 0;
      updateScoreComboUI();

      // Hi·ªÉn th·ªã quizContainer
      quizContainer.style.display = "block";
      startQuizBtn.disabled = true;
      levelSelect.disabled = true;

      // Hi·ªÉn th·ªã c√¢u ƒë·∫ßu
      showCurrentQuestion();

      // C·∫≠p nh·∫≠t badges (c·∫ßn g·ªçi updateBadges khi ch∆°i xong)
    }

    /**
     * Hi·ªÉn th·ªã c√¢u h·ªèi hi·ªán t·∫°i (quizWords[currentIdx])
     */
    function showCurrentQuestion() {
      // L·∫•y object t·ª´ quizWords
      const item = quizWords[currentIdx];
      // C√¢u h·ªèi: Ch·ªçn ch·ªØ H√°n c√≥ nghƒ©a = item.meaning
      questionText.innerText = `Ch·ªçn ch·ªØ H√°n c√≥ nghƒ©a: ${item.meaning}`;
      // Random 3 ƒë√°p √°n sai + 1 ƒë√°p √°n ƒë√∫ng
      let pool = [item.hanzi];
      // L·∫•y ra 3 hanzi kh√°c ng·∫´u nhi√™n (kh√¥ng tr√πng)
      while (pool.length < 4) {
        const pick = allWords[Math.floor(Math.random() * allWords.length)].hanzi;
        if (!pool.includes(pick)) pool.push(pick);
      }
      // Shuffle pool
      pool.sort(() => Math.random() - 0.5);

      // X√≥a optionsContainer
      optionsContainer.innerHTML = "";

      // T·∫°o 4 n√∫t option
      pool.forEach(ch => {
        const optDiv = document.createElement("div");
        optDiv.className = "option";
        // T√¨m object trong allWords ƒë·ªÉ l·∫•y pinyin
        const obj = allWords.find(w => w.hanzi === ch);
        const pinyin = obj ? obj.pinyin : "";
        optDiv.innerHTML = `
          <span class="hanzi">${ch}</span>
          <span class="pinyin">${pinyin}</span>
        `;
        // B·∫•m v√†o option s·∫Ω g·ªçi selectOption()
        optDiv.addEventListener("click", () => selectOption(optDiv, ch === item.hanzi));
        optionsContainer.appendChild(optDiv);
      });

      // ·∫®n n√∫t Next, c·∫≠p nh·∫≠t progress
      nextBtn.style.display = "none";
      progressText.innerText = `${currentIdx + 1} / ${quizWords.length}`;
    }

    /**
     * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt option
     * @param {HTMLElement} optDiv ‚Äì th·∫ª div c·ªßa option v·ª´a click
     * @param {boolean} isCorrect ‚Äì ƒë√∫ng or sai
     */
    function selectOption(optDiv, isCorrect) {
      // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ option (disabled)
      Array.from(optionsContainer.children).forEach(d => {
        d.classList.add("disabled");
      });

      if (isCorrect) {
        // n·∫øu ƒë√∫ng ‚Üí highlight m√†u xanh
        optDiv.classList.add("correct");
        // TƒÉng score v√† combo
        combo += 1;
        if (combo > maxCombo) maxCombo = combo;
        // C∆° ch·∫ø ƒëi·ªÉm: m·ªói c√¢u ƒë√∫ng +10, n·∫øu combo >1 th√¨ c·ªông th√™m combo*2
        score += 10 + (combo > 1 ? combo * 2 : 0);
        correctAnswersCount += 1;
      } else {
        // n·∫øu sai ‚Üí highlight ƒë·ªè + combo reset
        optDiv.classList.add("wrong");
        combo = 0;
      }

      updateScoreComboUI();

      // Hi·ªán n√∫t Next
      nextBtn.style.display = "block";
    }

    /**
     * C·∫≠p nh·∫≠t UI cho Score v√† Combo
     */
    function updateScoreComboUI() {
      scoreValue.innerText = score;
      comboValue.innerText = combo;
    }

    /**
     * B·∫•m Next ƒë·ªÉ chuy·ªÉn c√¢u ti·∫øp theo
     */
    function nextQuestion() {
      currentIdx += 1;
      if (currentIdx < quizWords.length) {
        showCurrentQuestion();
      } else {
        // K·∫øt th√∫c quiz ‚Äì hi·ªÉn th·ªã k·∫øt qu·∫£ & x·ª≠ l√Ω badges, leaderboard
        finishQuiz();
      }
    }

    /**
     * Khi quiz k·∫øt th√∫c:
     * 1) G·ªçi updateBadges v·ªõi stats hi·ªán t·∫°i
     * 2) G·ªçi addToLeaderboard (sau khi ng∆∞·ªùi ch∆°i nh·∫≠p t√™n)
     * 3) Cho ph√©p restart (v·ªÅ l·∫°i m√†n ch·ªçn level)
     */
    function finishQuiz() {
      // C·∫≠p nh·∫≠t badges
      updateBadges({
        correctAnswers: correctAnswersCount,
        maxCombo: maxCombo,
        streak: streakDays
      });

      // Y√™u c·∫ßu ng∆∞·ªùi ch∆°i nh·∫≠p t√™n (prompt)
      let name = prompt("K·∫øt th√∫c Quiz! ƒêi·ªÉm c·ªßa b·∫°n: " + score + "\nH√£y nh·∫≠p t√™n c·ªßa b·∫°n ƒë·ªÉ l∆∞u v√†o BXH:", "");
      if (name && name.trim().length) {
        addToLeaderboard(name.trim(), score);
      } else {
        // N·∫øu kh√¥ng nh·∫≠p, ta v·∫´n render leaderboard nh∆∞ng kh√¥ng add m·ªõi
        renderLeaderboard();
      }

      // Hi·ªÉn th·ªã alert t·ªïng k·∫øt
      alert(`K·∫øt th√∫c Quiz!\nƒêi·ªÉm c·ªßa b·∫°n: ${score}\nCombo cao nh·∫•t: ${maxCombo}\nChu·ªói ng√†y h·ªçc li√™n ti·∫øp: ${streakDays}`);

      // Cho ph√©p ch∆°i l·∫°i: ·∫©n quiz, m·ªü l·∫°i n√∫t start
      quizContainer.style.display = "none";
      startQuizBtn.disabled = false;
      levelSelect.disabled = false;
    }

    //
    // ‚îÄ‚îÄ‚îÄ VII. KH·ªûI ƒê·ªòNG L·∫¶N ƒê·∫¶U (Event Listeners & Load) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //

    // Khi ‚ÄúB·∫Øt ƒë·∫ßu Quiz‚Äù ƒë∆∞·ª£c ·∫•n
    startQuizBtn.addEventListener("click", () => {
      startQuiz();
    });

    // Khi ‚ÄúNext‚Äù ƒë∆∞·ª£c ·∫•n
    nextBtn.addEventListener("click", () => {
      nextQuestion();
    });

    // Khi trang v·ª´a t·∫£i xong
    window.addEventListener("load", async () => {
      // 1) T·∫£i JSON t·ª´ words.json
      await loadAllWords();

      // 2) Kh·ªüi t·∫°o ho·∫∑c c·∫≠p nh·∫≠t streak (d·ª±a v√†o lastPlayedDate)
      initOrUpdateStreak();

      // 3) Hi·ªÉn th·ªã badges (m·∫£ng earnedBadges) n·∫øu ƒë√£ c√≥
      renderBadges();

      // 4) Hi·ªÉn th·ªã leaderboard
      renderLeaderboard();
    });

  })();
  </script>

</body>
</html>
